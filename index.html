<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drukarka Zebra - Orlen Paczka</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; padding: 20px; background: #ececec; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); display: inline-block; width: 100%; max-width: 450px; }
        
        /* Styl dla inputu */
        input { 
            font-size: 1.5rem; 
            padding: 12px; 
            width: 90%; 
            margin-bottom: 15px; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            text-align: center;
            letter-spacing: 2px;
        }
        input:focus { border-color: #e63946; outline: none; }

        /* Przyciski */
        button { font-size: 1.1rem; padding: 15px; width: 100%; cursor: pointer; border: none; border-radius: 8px; color: white; margin-bottom: 10px; transition: 0.3s; font-weight: bold; text-transform: uppercase; }
        
        .btn-print { background-color: #e63946; }
        .btn-print:active { background-color: #b91d2a; transform: scale(0.98); }

        .btn-scan { background-color: #333; margin-bottom: 20px; }
        .btn-scan:active { background-color: #000; transform: scale(0.98); }

        /* Obszar kamery */
        #reader { width: 100%; display: none; margin-bottom: 20px; border-radius: 8px; overflow: hidden; border: 2px dashed #333; }

        #barcode-preview { margin-top: 20px; width: 100%; height: auto; }
        .status { margin-top: 15px; font-weight: bold; color: #555; height: 20px; }
    </style>
</head>
<body>

    <div class="card">
        <h2 style="color: #e63946;">ORLEN PACZKA</h2>
        
        <div id="reader"></div>
        <button id="scan-btn" class="btn-scan" onclick="toggleCamera()">üì∑ Skanuj KamerƒÖ</button>

        <input type="text" 
               id="ean-input" 
               inputmode="numeric" 
               pattern="[0-9]*" 
               placeholder="Wpisz lub zeskanuj kod" 
               maxlength="20" 
               oninput="validateInput(this)">

        <button class="btn-print" onclick="printToZebra()">üñ®Ô∏è Drukuj Etykietƒô</button>
        <div id="status-msg" class="status">Gotowy</div>
        
        <div style="border-top: 1px solid #eee; margin-top: 20px;">
            <svg id="barcode-preview"></svg>
        </div>
    </div>

    <script>
        let html5QrcodeScanner = null;
        let isScanning = false;

        // Funkcja obs≈ÇugujƒÖca kamerƒô
        function toggleCamera() {
            const scanBtn = document.getElementById('scan-btn');
            const readerDiv = document.getElementById('reader');

            if (isScanning) {
                // Zatrzymaj skanowanie
                if (html5QrcodeScanner) {
                    html5QrcodeScanner.stop().then(() => {
                        readerDiv.style.display = "none";
                        scanBtn.innerText = "üì∑ Skanuj KamerƒÖ";
                        isScanning = false;
                    }).catch(err => console.error(err));
                }
            } else {
                // Rozpocznij skanowanie
                readerDiv.style.display = "block";
                scanBtn.innerText = "‚ùå Zatrzymaj kamerƒô";
                isScanning = true;

                html5QrcodeScanner = new Html5Qrcode("reader");
                
                // Konfiguracja skanera
                const config = { fps: 10, qrbox: { width: 250, height: 150 } };
                
                // Preferuj tylnƒÖ kamerƒô (environment)
                html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess);
            }
        }

        // Gdy kod zostanie wykryty
        function onScanSuccess(decodedText, decodedResult) {
            console.log(`Zeskanowano: ${decodedText}`);
            
            const input = document.getElementById('ean-input');
            input.value = decodedText;
            
            // Wywo≈Çaj walidacjƒô i generator podglƒÖdu rƒôcznie
            validateInput(input);
            
            // Zatrzymaj kamerƒô po udanym skanie
            toggleCamera();
            
            // Opcjonalnie: automatyczne wywo≈Çanie druku (odkomentuj poni≈ºej je≈õli chcesz)
            // printToZebra(); 
        }

        // --- STARA LOGIKA (bez zmian) ---

        function validateInput(input) {
            // Usuwa wszystko co nie jest cyfrƒÖ (chyba ≈ºe kody Orlenu majƒÖ litery - wtedy usu≈Ñ tƒô liniƒô)
            input.value = input.value.replace(/[^0-9]/g, '');
            
            if (input.value.length >= 1) {
                try {
                    JsBarcode("#barcode-preview", input.value, {
                        format: "CODE128", // Zmieni≈Çem na CODE128 bo EAN13 wymaga dok≈Çadnie 13 cyfr, a paczki sƒÖ r√≥≈ºne
                        flat: true,
                        width: 2,
                        height: 60,
                        fontSize: 16
                    });
                } catch (e) {
                    console.log("Kod za kr√≥tki lub nieprawid≈Çowy dla tego formatu");
                }
            }
        }

        async function printToZebra() {
            const eanValue = document.getElementById('ean-input').value;
            const status = document.getElementById('status-msg');

            if (eanValue.length < 5) { // Zmniejszy≈Çem limit, bo paczki bywajƒÖ r√≥≈ºne
                alert("Wpisz poprawny numer przesy≈Çki!");
                return;
            }

            // U≈ºywam CODE128 (BC) w ZPL, jest bardziej uniwersalny dla logistyki ni≈º EAN13 (BE)
            const zpl = `^XA
^BY3,2,100^FT50,120^BCN,100,Y,N,N^FD${eanValue}^FS
^FT0,250^A0N,30,30^FB410,3,0,C^FDORLEN PACZKA^FS
^XZ`;

            console.log("%c--- ZPL ---", "color: red");
            console.log(zpl);

            try {
                status.innerText = "≈ÅƒÖczenie...";
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'ZQ' }, { namePrefix: 'Zebra' }],
                    optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb']
                });

                const server = await device.gatt.connect();
                const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
                const characteristic = await service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');

                await characteristic.writeValue(new TextEncoder().encode(zpl));
                status.innerText = "Wydrukowano!";
                
                setTimeout(() => { 
                    if(device.gatt.connected) device.gatt.disconnect(); 
                }, 2000);
            } catch (error) {
                console.error(error);
                status.innerText = "B≈ÇƒÖd: " + error.message;
            }
        }
    </script>
</body>
</html>
