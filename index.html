<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drukarka Zebra ZQ - Web Print</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; padding: 15px; background: #f4f4f4; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 500px; margin: 0 auto; }
        h2 { color: #d32f2f; margin-top: 0; }

        /* --- STYL KAMERY (Mniejsze okno) --- */
        #camera-container { 
            position: relative; 
            display: none; /* Domy≈õlnie ukryta */
            margin-bottom: 15px; 
            border-radius: 10px; 
            overflow: hidden; 
            background: #000;
            height: 180px; /* Ograniczona wysoko≈õƒá */
            border: 2px solid #333;
        }

        video { 
            width: 100%; 
            height: 100%; 
            display: block; 
            object-fit: cover; /* Obraz wype≈Çnia okno, przycinajƒÖc g√≥rƒô i d√≥≈Ç */
        }

        /* Czerwona ramka celownika */
        .overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            border: 2px solid rgba(230, 57, 70, 0.8); width: 80%; height: 50px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5); pointer-events: none;
        }
        .overlay::after { content: "Umie≈õƒá numer w ramce"; position: absolute; top: -20px; left: 0; width: 100%; color: white; font-size: 10px; }

        canvas { display: none; }

        /* --- STYL ELEMENT√ìW FORMULARZA --- */
        input { 
            font-size: 1.4rem; padding: 10px; width: 100%; box-sizing: border-box;
            margin-bottom: 15px; border: 2px solid #ccc; border-radius: 8px; 
            text-align: center; letter-spacing: 2px; font-weight: bold;
        }
        input:focus { border-color: #d32f2f; outline: none; }

        button { 
            font-size: 1rem; padding: 12px; width: 100%; cursor: pointer; 
            border: none; border-radius: 8px; color: white; margin-bottom: 8px; 
            font-weight: bold; text-transform: uppercase; transition: 0.2s;
        }
        
        .btn-print { background-color: #d32f2f; height: 60px; font-size: 1.2rem; } /* Czerwony Orlen */
        .btn-print:active { background-color: #b71c1c; }

        .btn-cam { background-color: #333; }
        .btn-snap { background-color: #2a9d8f; display: none; } /* Zielony przycisk skanowania */

        #status-msg { margin-top: 10px; font-weight: bold; color: #555; min-height: 1.2em; }
        #barcode-preview { margin-top: 10px; max-width: 100%; height: auto; }
    </style>
</head>
<body>

    <div class="card">
        <h2>ORLEN PACZKA</h2>
        
        <div id="camera-container">
            <video id="video" playsinline autoplay></video>
            <div class="overlay"></div>
            <canvas id="canvas"></canvas>
        </div>

        <div style="display: flex; gap: 5px; margin-bottom: 10px;">
            <button id="btn-toggle-cam" class="btn-cam" onclick="toggleCamera()">üì∑ Kamera</button>
            <button id="btn-snap" class="btn-snap" onclick="captureAndRead()">‚ö° Czytaj</button>
        </div>

        <input type="text" id="ean-input" inputmode="numeric" placeholder="13 cyfr" maxlength="15" oninput="validateInput(this)">

        <button class="btn-print" onclick="printToZebra()">üñ®Ô∏è DRUKUJ ETYKIETƒò</button>
        
        <div id="status-msg">Gotowy do pracy</div>
        
        <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">
        <svg id="barcode-preview"></svg>
    </div>

    <script>
        // --- KONFIGURACJA ZEBRA BLUETOOTH LE (Dla ZQ521 i nowszych) ---
        // To sƒÖ oficjalne identyfikatory us≈Çug Zebry (Link-OS)
        const ZEBRA_SERVICE_UUID = '38eb4a80-c570-11e3-9507-0002a5d5c51b';
        const ZEBRA_WRITE_CHAR_UUID = '38eb4a82-c570-11e3-9507-0002a5d5c51b';

        let stream = null;
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const statusMsg = document.getElementById('status-msg');

        // 1. KAMERA
        async function toggleCamera() {
            if (stream) {
                stopCamera();
            } else {
                try {
                    statusMsg.innerText = "Uruchamianie kamery...";
                    stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 } } 
                    });
                    video.srcObject = stream;
                    document.getElementById('camera-container').style.display = 'block';
                    document.getElementById('btn-snap').style.display = 'block';
                    document.getElementById('btn-toggle-cam').innerText = "‚ùå Zamknij";
                    statusMsg.innerText = "Nakieruj cyfry w ramkƒô";
                } catch (err) {
                    alert("Nie mo≈ºna otworzyƒá kamery. Sprawd≈∫ uprawnienia w przeglƒÖdarce.");
                }
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            document.getElementById('camera-container').style.display = 'none';
            document.getElementById('btn-snap').style.display = 'none';
            document.getElementById('btn-toggle-cam').innerText = "üì∑ Kamera";
            statusMsg.innerText = "Kamera wy≈ÇƒÖczona";
        }

        // 2. OCR (Tesseract)
        async function captureAndRead() {
            if (!stream) return;
            statusMsg.innerText = "‚è≥ Analizujƒô obraz...";
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            try {
                // Rozpoznaj tekst
                const { data: { text } } = await Tesseract.recognize(canvas, 'eng', {
                    // Optymalizacja: szukamy tylko cyfr, to bardzo przyspiesza dzia≈Çanie
                    tessedit_char_whitelist: '0123456789' 
                });

                console.log("Odczytano:", text);
                
                // Szukamy ciƒÖgu 12 lub 13 cyfr
                const match = text.match(/\d{12,13}/);
                
                if (match) {
                    const code = match[0];
                    document.getElementById('ean-input').value = code;
                    validateInput(document.getElementById('ean-input'));
                    statusMsg.innerText = "Sukces! Zeskanowano: " + code;
                    stopCamera(); // Automatyczne zamkniƒôcie po sukcesie
                } else {
                    statusMsg.innerText = "Nie widzƒô wyra≈∫nych cyfr. Spr√≥buj ponownie.";
                }
            } catch (err) {
                console.error(err);
                statusMsg.innerText = "B≈ÇƒÖd rozpoznawania.";
            }
        }

        // 3. WALIDACJA I PODGLƒÑD
        function validateInput(input) {
            input.value = input.value.replace(/[^0-9]/g, ''); // Tylko cyfry
            if (input.value.length >= 8) { // Generuj podglƒÖd je≈õli jest chocia≈º trochƒô cyfr
                try {
                    JsBarcode("#barcode-preview", input.value, {
                        format: "EAN13", // Lub CODE128 je≈õli wolisz
                        flat: true, width: 2, height: 50, displayValue: true
                    });
                } catch (e) {}
            }
        }

        // 4. DRUKOWANIE (Bluetooth)
        async function printToZebra() {
            const eanValue = document.getElementById('ean-input').value;
            
            if (eanValue.length < 12) {
                alert("Wpisz poprawny numer (min. 12 cyfr)!");
                return;
            }

            // Przygotowanie kodu ZPL
            // ^XA - Start, ^PW - Szeroko≈õƒá (opcjonalnie), ^BY - Parametry kodu
            // ^BEN - Kod EAN13
            // UWAGA: Je≈õli drukarka ma ZPL, to zadzia≈Ça od razu.
            const zpl = `
^XA
^PW580
^BY3,2,100
^FT60,130^BEN,100,Y,N^FD${eanValue.substring(0,12)}^FS
^FT0,260^A0N,35,35^FB550,1,0,C^FDORLEN PACZKA^FS
^XZ`;

            try {
                statusMsg.innerText = "Szukam drukarki...";
                
                // Prosimy o urzƒÖdzenie z konkretnym UUID us≈Çugi Zebry
                const device = await navigator.bluetooth.requestDevice({
                    filters: [
                        { services: [ZEBRA_SERVICE_UUID] } 
                        // To filtrowanie jest bezpieczniejsze ni≈º po nazwie
                    ],
                    optionalServices: [ZEBRA_SERVICE_UUID]
                });

                statusMsg.innerText = "≈ÅƒÖczenie...";
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(ZEBRA_SERVICE_UUID);
                const characteristic = await service.getCharacteristic(ZEBRA_WRITE_CHAR_UUID);

                statusMsg.innerText = "Wysy≈Çanie...";
                
                // Konwersja tekstu na bajty
                const encoder = new TextEncoder();
                await characteristic.writeValue(encoder.encode(zpl));

                statusMsg.innerText = "‚úÖ Wydrukowano!";
                
                // Roz≈ÇƒÖcz po 2 sekundach, ≈ºeby zwolniƒá drukarkƒô
                setTimeout(() => { if(device.gatt.connected) device.gatt.disconnect(); }, 2000);

            } catch (error) {
                console.error(error);
                statusMsg.innerText = "B≈ÇƒÖd: " + error.message;
                if(error.name === 'NotFoundError') {
                    statusMsg.innerText = "Anulowano lub nie znaleziono Zebry.";
                }
            }
        }
    </script>
</body>
</html>
