<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator PDF dla Zebra Print</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    
    <style>
        body { font-family: sans-serif; padding: 20px; text-align: center; background: #f4f4f4; }
        .card { background: white; padding: 20px; border-radius: 10px; max-width: 400px; margin: 0 auto; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        input { width: 100%; padding: 10px; font-size: 1.2rem; text-align: center; margin: 10px 0; border: 2px solid #ddd; border-radius: 5px; }
        button { width: 100%; padding: 15px; font-size: 1.1rem; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px; font-weight: bold; color: white; }
        .btn-pdf { background-color: #d32f2f; } /* Orlen Red */
        .btn-cam { background-color: #333; margin-bottom: 5px; }
        
        #preview-container { margin-top: 20px; display: none; }
        #barcode { display: none; } /* Ukryty canvas, sÅ‚uÅ¼y tylko do generowania */
        
        video { width: 100%; border-radius: 5px; margin-bottom: 10px; display: none; }
    </style>
</head>
<body>

<div class="card">
    <h2 style="color:#d32f2f">Generuj EtykietÄ™</h2>
    
    <video id="video" playsinline autoplay></video>
    <button class="btn-cam" onclick="toggleCamera()">ðŸ“· Skanuj KamerÄ…</button>
    <canvas id="canvas" style="display:none"></canvas>

    <input type="text" id="ean-input" placeholder="Wpisz numer paczki (13 cyfr)" maxlength="13">

    <button class="btn-pdf" onclick="generateAndOpenPDF()">ðŸ“„ OTWÃ“RZ W ZEBRA PRINT</button>
    
    <div id="status" style="margin-top:15px; color: #555;">Gotowy.</div>

    <svg id="barcode"></svg>
</div>

<script>
    // --- 1. KAMERA I OCR (SkrÃ³cona wersja) ---
    let stream;
    async function toggleCamera() {
        const video = document.getElementById('video');
        if(stream) {
            stream.getTracks().forEach(t => t.stop()); stream = null; video.style.display='none';
        } else {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = stream; video.style.display='block';
                scanFrame();
            } catch(e) { alert("BÅ‚Ä…d kamery"); }
        }
    }
    
    async function scanFrame() {
        if(!stream) return;
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video,0,0);
        
        try {
            const { data: { text } } = await Tesseract.recognize(canvas, 'eng', { tessedit_char_whitelist: '0123456789' });
            const match = text.match(/\d{12,13}/);
            if(match) {
                document.getElementById('ean-input').value = match[0];
                document.getElementById('status').innerText = "Zeskanowano!";
                toggleCamera(); // WyÅ‚Ä…cz po znalezieniu
            } else {
                requestAnimationFrame(scanFrame);
            }
        } catch(e) {}
    }

    // --- 2. GENEROWANIE PDF DLA APLIKACJI ZEBRA ---
    async function generateAndOpenPDF() {
        const ean = document.getElementById('ean-input').value;
        if(ean.length < 12) { alert("Wpisz poprawny numer!"); return; }

        const { jsPDF } = window.jspdf;
        
        // 1. Ustawienia PDF: 4 x 6 cali (w mm: 101.6 x 152.4)
        // Orientacja portretowa ('p'), jednostka milimetry ('mm')
        const doc = new jsPDF({
            orientation: 'p',
            unit: 'mm',
            format: [101.6, 152.4] 
        });

        // 2. Generowanie obrazka kodu kreskowego (SVG -> Canvas -> Image Data)
        // To trochÄ™ skomplikowane w JS, ale JsBarcode robi to najproÅ›ciej
        JsBarcode("#barcode", ean, {
            format: "EAN13",
            width: 4,       // SzerokoÅ›Ä‡ paska
            height: 100,    // WysokoÅ›Ä‡ kodu
            displayValue: true,
            fontSize: 40,
            margin: 10
        });

        // Konwersja SVG (z JsBarcode) na DataURL, Å¼eby wstawiÄ‡ do PDF
        const svg = document.getElementById('barcode');
        const xml = new XMLSerializer().serializeToString(svg);
        const svg64 = btoa(xml);
        const b64Start = 'data:image/svg+xml;base64,';
        const image64 = b64Start + svg64;

        // Musimy zamieniÄ‡ SVG na PNG w locie, bo jsPDF sÅ‚abo radzi sobie z czystym SVG
        // Tworzymy tymczasowy obrazek w pamiÄ™ci
        const img = new Image();
        img.src = image64;
        
        img.onload = function() {
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            const pngData = canvas.toDataURL('image/png');

            // 3. Rysowanie PDF
            // NagÅ‚Ã³wek
            doc.setFontSize(24);
            doc.text("ORLEN PACZKA", 50.8, 20, { align: "center" }); // 50.8 to Å›rodek (101.6 / 2)

            // Kod kreskowy (Wycentrowany)
            // x, y, width, height
            doc.addImage(pngData, 'PNG', 10, 40, 80, 50);

            // Stopka
            doc.setFontSize(16);
            doc.text("Etykieta Logistyczna", 50.8, 110, { align: "center" });

            // 4. ZAPISYWANIE I OTWIERANIE
            // Zapisujemy plik jako Blob i tworzymy URL
            const pdfBlob = doc.output('blob');
            const url = URL.createObjectURL(pdfBlob);
            
            // Otwieramy plik - Android powinien zapytaÄ‡ "Czym otworzyÄ‡?"
            // Wybierz wtedy "ZEBRA PRINT"
            const link = document.createElement('a');
            link.href = url;
            link.download = `Etykieta_${ean}.pdf`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            document.getElementById('status').innerText = "PDF wygenerowany! OtwÃ³rz w Zebra Print.";
        };
    }
</script>

</body>
</html>
