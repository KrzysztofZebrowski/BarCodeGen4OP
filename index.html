<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orlen Paczka - PDF Generator</title>
    
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    
    <style>
        :root { --orlen-red: #d32f2f; --dark: #222; --light: #f9f9f9; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: var(--light); 
            margin: 0; 
            padding: 15px; 
            display: flex; 
            justify-content: center; 
        }
        
        /* Kontener trzyma wszystko w ryzach - naprawia problem inputa */
        .container { 
            width: 100%; 
            max-width: 480px; 
            background: white; 
            padding: 20px; 
            border-radius: 16px; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.08); 
            box-sizing: border-box; /* Kluczowe dla margines√≥w */
        }
        
        h2 { 
            color: var(--orlen-red); 
            margin-top: 0; 
            text-transform: uppercase; 
            font-size: 1.4rem; 
            text-align: center; 
            letter-spacing: 1px;
        }

        /* --- STYL KAMERY (POWR√ìT DO 180PX + CELOWNIK) --- */
        #camera-wrapper { 
            display: none; 
            position: relative; 
            margin-bottom: 15px; 
            border-radius: 12px; 
            overflow: hidden; 
            background: #000; 
            border: 2px solid #333; 
            height: 180px; /* Sztywna wysoko≈õƒá jak prosi≈Çe≈õ */
            width: 100%;
        }
        
        video { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        }
        
        /* Celownik */
        .overlay { 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            width: 80%; 
            height: 60px; 
            border: 2px solid rgba(211, 47, 47, 0.9); /* Czerwona ramka */
            box-shadow: 0 0 0 100px rgba(0, 0, 0, 0.6); /* Przyciemnienie t≈Ça */
            z-index: 10;
            border-radius: 4px;
        }
        
        /* Czerwona kreska skanujƒÖca */
        .overlay::after {
            content: '';
            position: absolute;
            top: 50%; left: 0; right: 0;
            height: 2px;
            background: rgba(255, 0, 0, 0.5);
        }

        canvas { display: none; } /* Ukryty canvas do OCR i kod√≥w */
        #barcode-svg { display: none; } /* Ukryte SVG do generowania */

        /* --- INPUT (NAPRAWIONY) --- */
        .input-group { margin: 20px 0; }
        
        label { 
            font-size: 0.9rem; 
            font-weight: 700; 
            color: #555; 
            display: block; 
            margin-bottom: 8px; 
        }
        
        input { 
            width: 100%; /* Dopasuj do kontenera */
            padding: 14px; 
            font-size: 1.3rem; 
            border: 2px solid #e0e0e0; 
            border-radius: 8px; 
            box-sizing: border-box; /* To naprawia wyje≈ºd≈ºanie poza ekran! */
            text-align: center; 
            font-weight: bold; 
            letter-spacing: 2px;
            background: #fff;
            color: #333;
            transition: 0.3s;
        }
        
        input:focus { 
            border-color: var(--orlen-red); 
            outline: none; 
            background: #fff5f5; 
        }

        /* --- PRZYCISKI --- */
        button { 
            width: 100%; 
            padding: 14px; 
            border: none; 
            border-radius: 8px; 
            font-size: 1rem; 
            font-weight: 600; 
            cursor: pointer; 
            margin-bottom: 10px; 
            transition: transform 0.1s, background 0.2s; 
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        
        button:active { transform: scale(0.98); }
        
        .btn-cam { background: var(--dark); color: white; }
        .btn-scan { background: #2a9d8f; color: white; display: none; } /* Domy≈õlnie ukryty */
        
        .btn-print { 
            background: var(--orlen-red); 
            color: white; 
            font-size: 1.1rem; 
            margin-top: 15px; 
            box-shadow: 0 4px 10px rgba(211, 47, 47, 0.3);
        }

        #status { 
            margin-top: 15px; 
            font-size: 0.9rem; 
            color: #666; 
            text-align: center; 
            min-height: 20px; 
        }

    </style>
</head>
<body>

<div class="container">
    <h2>Orlen Druk PDF</h2>

    <div id="camera-wrapper">
        <video id="video" playsinline autoplay></video>
        <div class="overlay"></div> </div>
    <canvas id="canvas"></canvas>

    <button id="btn-cam-toggle" class="btn-cam" onclick="toggleCamera()">üì∑ W≈ÇƒÖcz Kamerƒô</button>
    <button id="btn-scan" class="btn-scan" onclick="captureAndRead()">‚ö° Skanuj Kod</button>

    <div class="input-group">
        <label>NUMER PACZKI (EAN-13)</label>
        <input type="text" id="ean-input" placeholder="Wpisz lub zeskanuj" maxlength="13">
    </div>

    <button class="btn-print" onclick="generateAndOpenPDF()">üìÑ OTW√ìRZ W ZEBRA PRINT</button>
    
    <div id="status">Gotowy do pracy.</div>

    <svg id="barcode-svg"></svg>
</div>

<script>
    // --- 1. KAMERA I OCR ---
    let stream = null;
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const statusDiv = document.getElementById('status');
    const btnScan = document.getElementById('btn-scan');
    const btnToggle = document.getElementById('btn-cam-toggle');
    const camWrapper = document.getElementById('camera-wrapper');

    async function toggleCamera() {
        if (stream) {
            stopCamera();
        } else {
            try {
                statusDiv.innerText = "Uruchamianie kamery...";
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" } 
                });
                video.srcObject = stream;
                camWrapper.style.display = 'block';
                btnScan.style.display = 'flex'; // Poka≈º przycisk skanowania
                btnToggle.innerText = "‚ùå Zamknij Kamerƒô";
                btnToggle.style.background = "#555";
                statusDiv.innerText = "Nakieruj kod na celownik";
            } catch (err) {
                alert("B≈ÇƒÖd kamery: " + err.message);
            }
        }
    }

    function stopCamera() {
        if (stream) stream.getTracks().forEach(t => t.stop());
        stream = null;
        camWrapper.style.display = 'none';
        btnScan.style.display = 'none';
        btnToggle.innerText = "üì∑ W≈ÇƒÖcz Kamerƒô";
        btnToggle.style.background = "var(--dark)";
        statusDiv.innerText = "Kamera wy≈ÇƒÖczona";
    }

    async function captureAndRead() {
        if (!stream) return;
        statusDiv.innerText = "‚è≥ Analizowanie obrazu...";
        
        // Pobieramy klatkƒô z wideo
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);

        try {
            // Rozpoznawanie tekstu (tylko cyfry)
            const { data: { text } } = await Tesseract.recognize(canvas, 'eng', { 
                tessedit_char_whitelist: '0123456789' 
            });
            
            // Szukamy ciƒÖgu 12 lub 13 cyfr
            const match = text.match(/\d{12,13}/);
            
            if (match) {
                document.getElementById('ean-input').value = match[0];
                statusDiv.innerText = `‚úÖ Zeskanowano: ${match[0]}`;
                stopCamera(); // Sukces - zamykamy kamerƒô
            } else {
                statusDiv.innerText = "‚ö†Ô∏è Nie wykryto kodu. Spr√≥buj ponownie.";
            }
        } catch (e) {
            console.error(e);
            statusDiv.innerText = "B≈ÇƒÖd OCR.";
        }
    }

    // --- 2. GENEROWANIE PDF DLA ZEBRA PRINT ---
    function generateAndOpenPDF() {
        const ean = document.getElementById('ean-input').value;
        const statusMsg = document.getElementById('status');
        
        if(ean.length < 12) { 
            alert("Wpisz poprawny numer (min. 12 cyfr)!"); 
            return; 
        }

        statusMsg.innerText = "Generowanie PDF...";

        // 1. Generuj SVG kodu kreskowego
        JsBarcode("#barcode-svg", ean, {
            format: "EAN13",
            width: 4,
            height: 100,
            displayValue: true,
            fontSize: 40,
            margin: 10
        });

        // 2. Konwersja SVG na PNG (dla PDF)
        const svgNode = document.getElementById('barcode-svg');
        const xml = new XMLSerializer().serializeToString(svgNode);
        const svg64 = btoa(xml);
        const image64 = 'data:image/svg+xml;base64,' + svg64;
        
        const img = new Image();
        img.src = image64;

        img.onload = function() {
            // Rysujemy na canvasie, ≈ºeby mieƒá czysty format obrazka
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = "white"; // Bia≈Çe t≈Ço pod kodem
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);
            
            const pngData = canvas.toDataURL('image/png');

            // 3. Tworzymy PDF (4x6 cali)
            const { jsPDF } = window.jspdf;
            // 4 cale = 101.6mm, 6 cali = 152.4mm
            const doc = new jsPDF({
                orientation: 'p',
                unit: 'mm',
                format: [101.6, 152.4]
            });

            // Nag≈Ç√≥wek
            doc.setFont("helvetica", "bold");
            doc.setFontSize(22);
            doc.text("ORLEN PACZKA", 50.8, 20, { align: "center" });

            // Kod kreskowy (obrazek)
            // Centrujemy: szeroko≈õƒá obrazka w PDF to 80mm
            // (101.6 - 80) / 2 = 10.8 marginesu
            doc.addImage(pngData, 'PNG', 10.8, 40, 80, 50);

            // Dodatkowe info
            doc.setFont("helvetica", "normal");
            doc.setFontSize(14);
            doc.text("Etykieta Logistyczna", 50.8, 110, { align: "center" });
            
            // Data i czas
            const date = new Date().toLocaleString('pl-PL');
            doc.setFontSize(10);
            doc.text(date, 50.8, 140, { align: "center" });

            // 4. Zapis i otwarcie
            const pdfBlob = doc.output('blob');
            const url = URL.createObjectURL(pdfBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `Etykieta_${ean}.pdf`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            statusMsg.innerText = "‚úÖ PDF gotowy! Wybierz aplikacjƒô Zebra Print.";
        };
    }
</script>

</body>
</html>
