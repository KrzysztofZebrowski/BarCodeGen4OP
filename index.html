<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drukarka Zebra - Orlen Paczka (OCR)</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; padding: 20px; background: #ececec; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); display: inline-block; width: 100%; max-width: 450px; }
        
        input { 
            font-size: 1.5rem; padding: 12px; width: 90%; margin-bottom: 15px; 
            border: 2px solid #ddd; border-radius: 8px; text-align: center; letter-spacing: 2px;
        }
        input:focus { border-color: #e63946; outline: none; }

        button { font-size: 1.1rem; padding: 15px; width: 100%; cursor: pointer; border: none; border-radius: 8px; color: white; margin-bottom: 10px; transition: 0.3s; font-weight: bold; text-transform: uppercase; }
        
        .btn-print { background-color: #e63946; }
        .btn-print:active { background-color: #b91d2a; transform: scale(0.98); }

        .btn-camera { background-color: #333; }
        .btn-snap { background-color: #2a9d8f; display: none; } /* Ukryty dop√≥ki kamera nie ruszy */

        /* Kontener kamery */
        #camera-container { position: relative; display: none; margin-bottom: 20px; border-radius: 8px; overflow: hidden; background: #000; }
        video { width: 100%; height: 40%; display: block; }
        canvas { display: none; } /* Ukryte p≈Ç√≥tno do zrzut√≥w */

        /* Nak≈Çadka celownika */
        .overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            border: 2px solid rgba(255, 0, 0, 0.7); width: 80%; height: 60px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5); pointer-events: none;
        }
        .overlay::after { content: "Umie≈õƒá cyfry w ramce"; position: absolute; top: -25px; left: 0; width: 100%; color: white; font-size: 12px; text-shadow: 1px 1px 2px black; }

        #barcode-preview { margin-top: 20px; width: 100%; height: auto; }
        .status { margin-top: 15px; font-weight: bold; color: #555; height: 20px; }
    </style>
</head>
<body>

    <div class="card">
        <h2 style="color: #e63946;">ORLEN PACZKA (OCR)</h2>
        
        <div id="camera-container">
            <video id="video" playsinline autoplay></video>
            <div class="overlay"></div>
            <canvas id="canvas"></canvas>
        </div>

        <button id="btn-toggle-cam" class="btn-camera" onclick="toggleCamera()">üì∑ W≈ÇƒÖcz Kamerƒô</button>
        <button id="btn-snap" class="btn-snap" onclick="captureAndRead()">‚ö° Odczytaj Cyfry</button>

        <input type="text" id="ean-input" inputmode="numeric" placeholder="Wpisz lub zeskanuj 13 cyfr" maxlength="13" oninput="validateInput(this)">

        <button class="btn-print" onclick="printToZebra()">üñ®Ô∏è Drukuj Etykietƒô</button>
        <div id="status-msg" class="status">Gotowy</div>
        
        <div style="border-top: 1px solid #eee; margin-top: 20px;">
            <svg id="barcode-preview"></svg>
        </div>
    </div>

    <script>
        let stream = null;
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const statusMsg = document.getElementById('status-msg');

        // 1. Obs≈Çuga kamery
        async function toggleCamera() {
            if (stream) {
                // Wy≈ÇƒÖczanie
                stream.getTracks().forEach(track => track.stop());
                stream = null;
                document.getElementById('camera-container').style.display = 'none';
                document.getElementById('btn-snap').style.display = 'none';
                document.getElementById('btn-toggle-cam').innerText = "üì∑ W≈ÇƒÖcz Kamerƒô";
                statusMsg.innerText = "Gotowy";
            } else {
                // W≈ÇƒÖczanie
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 } } 
                    });
                    video.srcObject = stream;
                    document.getElementById('camera-container').style.display = 'block';
                    document.getElementById('btn-snap').style.display = 'inline-block';
                    document.getElementById('btn-toggle-cam').innerText = "‚ùå Zamknij";
                    statusMsg.innerText = "Nakieruj na cyfry...";
                } catch (err) {
                    alert("B≈ÇƒÖd kamery: " + err.message);
                }
            }
        }

        // 2. Robienie zdjƒôcia i OCR
        async function captureAndRead() {
            if (!stream) return;
            
            statusMsg.innerText = "‚è≥ Przetwarzanie obrazu...";
            
            // Pobranie klatki z wideo na canvas
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Wyciƒôcie tylko ≈õrodka (tam gdzie jest ramka) dla lepszej skuteczno≈õci
            // Zak≈Çadamy, ≈ºe ramka jest na ≈õrodku i zajmuje ok 20% wysoko≈õci
            // To przyspieszy OCR (mniej do czytania)
            
            try {
                const { data: { text } } = await Tesseract.recognize(canvas, 'eng', {
                    // Kluczowa konfiguracja: szukamy TYLKO cyfr
                    tessedit_char_whitelist: '0123456789', 
                });

                console.log("OCR Raw:", text);
                
                // Znajd≈∫ ciƒÖg 13 cyfr w tek≈õcie
                // Regex szuka 12 lub 13 cyfr z rzƒôdu
                const match = text.match(/\d{12,13}/);
                
                if (match) {
                    const foundCode = match[0];
                    statusMsg.innerText = "Znaleziono: " + foundCode;
                    const input = document.getElementById('ean-input');
                    input.value = foundCode;
                    validateInput(input);
                    toggleCamera(); // Wy≈ÇƒÖcz kamerƒô po sukcesie
                } else {
                    statusMsg.innerText = "Nie rozpoznano cyfr. Spr√≥buj bli≈ºej.";
                }

            } catch (err) {
                console.error(err);
                statusMsg.innerText = "B≈ÇƒÖd OCR.";
            }
        }

        // 3. Walidacja i PodglƒÖd (dla EAN-13)
        function validateInput(input) {
            input.value = input.value.replace(/[^0-9]/g, '');
            
            if (input.value.length === 12 || input.value.length === 13) {
                try {
                    JsBarcode("#barcode-preview", input.value, {
                        format: "EAN13", // Orlen u≈ºywa EAN13
                        flat: true, width: 2, height: 60, fontSize: 16
                    });
                } catch (e) {
                    console.log("Czekam na pe≈Çny kod EAN...");
                }
            }
        }

        // 4. Drukowanie ZPL (dostosowane do EAN13)
        async function printToZebra() {
            const eanValue = document.getElementById('ean-input').value;
            
            if (eanValue.length !== 13) {
                // Czƒôsto EAN ma 12 cyfr + 1 kontrolna. Je≈õli wpiszesz 12, Zebra sama obliczy 13-stƒÖ.
                // Ale je≈õli masz surowy tekst 13 cyfr, to jest OK.
                if (eanValue.length !== 12) {
                     alert("Kod EAN musi mieƒá 12 lub 13 cyfr!");
                     return;
                }
            }

            // ^BEN - Komenda dla EAN-13 w jƒôzyku ZPL
            const zpl = `^XA
^BY3,2,100^FT50,120^BEN,100,Y,N^FD${eanValue.substring(0,12)}^FS
^FT0,250^A0N,30,30^FB410,3,0,C^FDORLEN PACZKA^FS
^XZ`;

            try {
                statusMsg.innerText = "≈ÅƒÖczenie...";
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'ZQ' }, { namePrefix: 'Zebra' }, { services: ['000018f0-0000-1000-8000-00805f9b34fb'] }]
                });

                const server = await device.gatt.connect();
                const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
                const characteristic = await service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');

                await characteristic.writeValue(new TextEncoder().encode(zpl));
                statusMsg.innerText = "Wys≈Çano!";
                setTimeout(() => { if(device.gatt.connected) device.gatt.disconnect(); }, 2000);
            } catch (error) {
                console.error(error);
                statusMsg.innerText = "B≈ÇƒÖd: " + error.message;
            }
        }
    </script>
</body>
</html>
